<!DOCTYPE html>

<html>
<head>
  <title>app.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="app.html">
                  app.js
                </a>
              
                
                <a class="source" href="prototype.html">
                  prototype.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>app.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">var</span> favicon = <span class="hljs-built_in">require</span>(<span class="hljs-string">'serve-favicon'</span>);
<span class="hljs-keyword">var</span> logger = <span class="hljs-built_in">require</span>(<span class="hljs-string">'morgan'</span>);
<span class="hljs-keyword">var</span> cookieParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cookie-parser'</span>);
<span class="hljs-keyword">var</span> bodyParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">'body-parser'</span>);

<span class="hljs-keyword">var</span> routes = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./routes/index'</span>);
<span class="hljs-keyword">var</span> users = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./routes/users'</span>);

<span class="hljs-keyword">var</span> app = express();</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> mongodb =<span class="hljs-built_in">require</span>(<span class="hljs-string">"mongodb"</span>);
<span class="hljs-keyword">var</span> mongoClient = mongodb.MongoClient;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>connection url - where our mongodb server is running</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> url = <span class="hljs-string">'mongodb://localhost:27017/proto'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>view engine setup</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>app.set(<span class="hljs-string">'views'</span>, path.join(__dirname, <span class="hljs-string">'views'</span>));
app.set(<span class="hljs-string">'view engine'</span>, <span class="hljs-string">'jade'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>uncomment after placing your favicon in /public
app.use(favicon(__dirname + ‘/public/favicon.ico’));</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>app.use(logger(<span class="hljs-string">'dev'</span>));
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: <span class="hljs-literal">false</span> }));
app.use(cookieParser());
app.use(express.static(path.join(__dirname, <span class="hljs-string">'public'</span>)));

app.use(<span class="hljs-string">'/'</span>, routes);
app.use(<span class="hljs-string">'/users'</span>, users);</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>catch 404 and forward to error handler</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>app.use(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{
  <span class="hljs-keyword">var</span> err = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Not Found'</span>);
  err.status = <span class="hljs-number">404</span>;
  next(err);
});</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>error handlers</p>

            </div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>development error handler
will print stacktrace</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">if</span> (app.get(<span class="hljs-string">'env'</span>) === <span class="hljs-string">'development'</span>) {
  app.use(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, req, res, next</span>) </span>{
    res.status(err.status || <span class="hljs-number">500</span>);
    res.render(<span class="hljs-string">'error'</span>, {
      message: err.message,
      error: err
    });
  });
}</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>production error handler
no stacktraces leaked to user</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>app.use(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, req, res, next</span>) </span>{
  res.status(err.status || <span class="hljs-number">500</span>);
  res.render(<span class="hljs-string">'error'</span>, {
    message: err.message,
    error: {}
  });
});


<span class="hljs-built_in">module</span>.exports = app;</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>—————-system parameters——————————————</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> alpha = <span class="hljs-number">0.6</span>;
<span class="hljs-keyword">var</span> beta = <span class="hljs-number">0.5</span>;
<span class="hljs-keyword">var</span> gamma1 = <span class="hljs-number">0.75</span>; <span class="hljs-comment">// for siblings</span>
<span class="hljs-keyword">var</span> gamma2 = <span class="hljs-number">0.25</span>; <span class="hljs-comment">// for cousins</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>——————————— CONSTANTS———————-</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> META= <span class="hljs-string">"meta"</span>;
<span class="hljs-keyword">var</span> KEY_NAME=<span class="hljs-string">"name"</span>;
<span class="hljs-keyword">var</span> KEY_ARS=<span class="hljs-string">"agg_rating_score"</span>;
<span class="hljs-keyword">var</span> KEY_ORC=<span class="hljs-string">"own_rating_cont"</span>;
<span class="hljs-keyword">var</span> KEY_CRC=<span class="hljs-string">"children_rating_cont"</span>;
<span class="hljs-keyword">var</span> KEY_OWR=<span class="hljs-string">"own_wmean_rating"</span>;
<span class="hljs-keyword">var</span> KEY_UWR=<span class="hljs-string">"universe_wmean_rating"</span>;
<span class="hljs-keyword">var</span> KEY_CRa=<span class="hljs-string">"consumer_ratings"</span>;
<span class="hljs-keyword">var</span> KEY_CRe=<span class="hljs-string">"consumer_relevance"</span>;
<span class="hljs-keyword">var</span> KEY_RTV=<span class="hljs-string">"rating_trust_value"</span>;
<span class="hljs-keyword">var</span> KEY_TV=<span class="hljs-string">"trust_votes"</span>;
<span class="hljs-keyword">var</span> KEY_CHILDREN=<span class="hljs-string">"children"</span>;
<span class="hljs-keyword">var</span> KEY_PARENT=<span class="hljs-string">"parent"</span>;
<span class="hljs-keyword">var</span> KEY_CHILDREN_NAME=<span class="hljs-string">"name"</span>;
<span class="hljs-keyword">var</span> KEY_CHILDREN_WT=<span class="hljs-string">"wt"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>——————————- helper methods</p>

            </div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>it assumes that connection has been established</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getJsonObjectByNameFromDB</span>(<span class="hljs-params">name, collection, cb</span>)</span>{
	<span class="hljs-keyword">var</span> myCursor = collection.find({<span class="hljs-string">"name"</span>:name});
	myCursor.limit(<span class="hljs-number">1</span>);			
	myCursor.each(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err,result</span>)</span>{
		<span class="hljs-keyword">if</span>(err)cb(err);
		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(result!=<span class="hljs-literal">null</span>){
			cb(<span class="hljs-string">""</span>, result);
		}
	});
}</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>mongoClient.connect(url, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, db</span>)</span>{
	<span class="hljs-keyword">if</span>(err) <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"there was an error: "</span> ,err);
	<span class="hljs-keyword">else</span> {
				
		<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"connection esatblished to url "</span>,url);
		<span class="hljs-keyword">var</span> clln = db.collection(<span class="hljs-string">"services"</span>);
		<span class="hljs-keyword">var</span> service_data = [
					{ 
						name:<span class="hljs-string">"meta"</span>,						
						root:<span class="hljs-string">"a"</span>,
						numServices:<span class="hljs-number">7</span>,
						serviceNames:[<span class="hljs-string">"a"</span>,<span class="hljs-string">"b1"</span>,<span class="hljs-string">"b2"</span>,<span class="hljs-string">"c1"</span>,<span class="hljs-string">"c2"</span>,<span class="hljs-string">"c3"</span>,<span class="hljs-string">"c4"</span>]					
					},
					{
						<span class="hljs-string">"name"</span>:<span class="hljs-string">"a"</span>,
						<span class="hljs-string">"agg_rating_score"</span>:-<span class="hljs-number">1</span>,
						<span class="hljs-string">"own_rating_cont"</span>:-<span class="hljs-number">1</span>,
						<span class="hljs-string">"children_rating_cont"</span>:-<span class="hljs-number">1</span>,
						<span class="hljs-string">"own_wmean_rating"</span>:-<span class="hljs-number">1</span>,						
						<span class="hljs-string">"universe_wmean_rating"</span>:-<span class="hljs-number">1</span>,
						<span class="hljs-string">"consumer_ratings"</span>:[<span class="hljs-number">5</span>,<span class="hljs-number">4</span>],
						<span class="hljs-string">"consumer_relevance"</span>:[<span class="hljs-number">4</span>,<span class="hljs-number">5</span>],
						<span class="hljs-string">"rating_trust_value"</span>:-<span class="hljs-number">1</span>,
						<span class="hljs-string">"trust_votes"</span>:-<span class="hljs-number">1</span>,
						<span class="hljs-string">"children"</span>:[{<span class="hljs-string">"name"</span>:<span class="hljs-string">"b1"</span>,<span class="hljs-string">"wt"</span>:<span class="hljs-number">0.5</span>},{<span class="hljs-string">"name"</span>:<span class="hljs-string">"b2"</span>,<span class="hljs-string">"wt"</span>:<span class="hljs-number">0.5</span>}],
						<span class="hljs-string">"parent"</span>:[]
			
					
					},
					{
						<span class="hljs-string">"name"</span>:<span class="hljs-string">"b1"</span>,
						<span class="hljs-string">"agg_rating_score"</span>:-<span class="hljs-number">1</span>,
						<span class="hljs-string">"own_rating_cont"</span>:-<span class="hljs-number">1</span>,
						<span class="hljs-string">"children_rating_cont"</span>:-<span class="hljs-number">1</span>,
						<span class="hljs-string">"own_wmean_rating"</span>:-<span class="hljs-number">1</span>,						
						<span class="hljs-string">"universe_wmean_rating"</span>:-<span class="hljs-number">1</span>,
						<span class="hljs-string">"consumer_ratings"</span>:[<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">3</span>],
						<span class="hljs-string">"consumer_relevance"</span>:[<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">4</span>],
						<span class="hljs-string">"rating_trust_value"</span>:-<span class="hljs-number">1</span>,
						<span class="hljs-string">"trust_votes"</span>:-<span class="hljs-number">1</span>,
						<span class="hljs-string">"children"</span>:[{<span class="hljs-string">"name"</span>:<span class="hljs-string">"c1"</span>,<span class="hljs-string">"wt"</span>:<span class="hljs-number">0.6</span>},{<span class="hljs-string">"name"</span>:<span class="hljs-string">"c2"</span>,<span class="hljs-string">"wt"</span>:<span class="hljs-number">0.4</span>}],
						<span class="hljs-string">"parent"</span>:[<span class="hljs-string">"a"</span>]
			
					
					},
					{	
						<span class="hljs-string">"name"</span>:<span class="hljs-string">"b2"</span>,
						<span class="hljs-string">"agg_rating_score"</span>:-<span class="hljs-number">1</span>,
						<span class="hljs-string">"own_rating_cont"</span>:-<span class="hljs-number">1</span>,
						<span class="hljs-string">"children_rating_cont"</span>:-<span class="hljs-number">1</span>,
						<span class="hljs-string">"own_wmean_rating"</span>:-<span class="hljs-number">1</span>,						
						<span class="hljs-string">"universe_wmean_rating"</span>:-<span class="hljs-number">1</span>,
						<span class="hljs-string">"consumer_ratings"</span>:[<span class="hljs-number">5</span>],
						<span class="hljs-string">"consumer_relevance"</span>:[<span class="hljs-number">5</span>],
						<span class="hljs-string">"rating_trust_value"</span>:-<span class="hljs-number">1</span>,
						<span class="hljs-string">"trust_votes"</span>:-<span class="hljs-number">1</span>,
						<span class="hljs-string">"children"</span>:[{<span class="hljs-string">"name"</span>:<span class="hljs-string">"c3"</span>,<span class="hljs-string">"wt"</span>:<span class="hljs-number">0.3</span>},{<span class="hljs-string">"name"</span>:<span class="hljs-string">"c4"</span>,<span class="hljs-string">"wt"</span>:<span class="hljs-number">0.7</span>}],
						<span class="hljs-string">"parent"</span>:[<span class="hljs-string">"a"</span>]
			
					
					},	
					{
						<span class="hljs-string">"name"</span>:<span class="hljs-string">"c1"</span>,
						<span class="hljs-string">"agg_rating_score"</span>:-<span class="hljs-number">1</span>,
						<span class="hljs-string">"own_rating_cont"</span>:-<span class="hljs-number">1</span>,
						<span class="hljs-string">"children_rating_cont"</span>:-<span class="hljs-number">1</span>,
						<span class="hljs-string">"own_wmean_rating"</span>:-<span class="hljs-number">1</span>,						
						<span class="hljs-string">"universe_wmean_rating"</span>:-<span class="hljs-number">1</span>,
						<span class="hljs-string">"consumer_ratings"</span>:[<span class="hljs-number">4</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">3</span>],
						<span class="hljs-string">"consumer_relevance"</span>:[<span class="hljs-number">5</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">3</span>],
						<span class="hljs-string">"rating_trust_value"</span>:-<span class="hljs-number">1</span>,
						<span class="hljs-string">"trust_votes"</span>:-<span class="hljs-number">1</span>,
						<span class="hljs-string">"children"</span>:[],
						<span class="hljs-string">"parent"</span>:[<span class="hljs-string">"b1"</span>]
		
					
					},
					{					
						<span class="hljs-string">"name"</span>:<span class="hljs-string">"c2"</span>,
						<span class="hljs-string">"agg_rating_score"</span>:-<span class="hljs-number">1</span>,
						<span class="hljs-string">"own_rating_cont"</span>:-<span class="hljs-number">1</span>,
						<span class="hljs-string">"children_rating_cont"</span>:-<span class="hljs-number">1</span>,
						<span class="hljs-string">"own_wmean_rating"</span>:-<span class="hljs-number">1</span>,						
						<span class="hljs-string">"universe_wmean_rating"</span>:-<span class="hljs-number">1</span>,
						<span class="hljs-string">"consumer_ratings"</span>:[<span class="hljs-number">3</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>],
						<span class="hljs-string">"consumer_relevance"</span>:[<span class="hljs-number">4</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>],
						<span class="hljs-string">"rating_trust_value"</span>:-<span class="hljs-number">1</span>,
						<span class="hljs-string">"trust_votes"</span>:-<span class="hljs-number">1</span>,
						<span class="hljs-string">"children"</span>:[],
						<span class="hljs-string">"parent"</span>:[<span class="hljs-string">"b1"</span>]
			
					
					},
					{
						<span class="hljs-string">"name"</span>:<span class="hljs-string">"c3"</span>,
						<span class="hljs-string">"agg_rating_score"</span>:-<span class="hljs-number">1</span>,
						<span class="hljs-string">"own_rating_cont"</span>:-<span class="hljs-number">1</span>,
						<span class="hljs-string">"children_rating_cont"</span>:-<span class="hljs-number">1</span>,
						<span class="hljs-string">"own_wmean_rating"</span>:-<span class="hljs-number">1</span>,						
						<span class="hljs-string">"universe_wmean_rating"</span>:-<span class="hljs-number">1</span>,
						<span class="hljs-string">"consumer_ratings"</span>:[<span class="hljs-number">4</span>,<span class="hljs-number">4</span>],
						<span class="hljs-string">"consumer_relevance"</span>:[<span class="hljs-number">4</span>,<span class="hljs-number">5</span>],
						<span class="hljs-string">"rating_trust_value"</span>:-<span class="hljs-number">1</span>,
						<span class="hljs-string">"trust_votes"</span>:-<span class="hljs-number">1</span>,
						<span class="hljs-string">"children"</span>:[],
						<span class="hljs-string">"parent"</span>:[<span class="hljs-string">"b2"</span>]
			
					
					},
					{
							<span class="hljs-string">"name"</span>:<span class="hljs-string">"c4"</span>,
							<span class="hljs-string">"agg_rating_score"</span>:-<span class="hljs-number">1</span>,
							<span class="hljs-string">"own_rating_cont"</span>:-<span class="hljs-number">1</span>,
							<span class="hljs-string">"children_rating_cont"</span>:-<span class="hljs-number">1</span>,
							<span class="hljs-string">"own_wmean_rating"</span>:-<span class="hljs-number">1</span>,						
							<span class="hljs-string">"universe_wmean_rating"</span>:-<span class="hljs-number">1</span>,
							<span class="hljs-string">"consumer_ratings"</span>:[<span class="hljs-number">5</span>,<span class="hljs-number">5</span>,<span class="hljs-number">4</span>],
							<span class="hljs-string">"consumer_relevance"</span>:[<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">4</span>],
							<span class="hljs-string">"rating_trust_value"</span>:-<span class="hljs-number">1</span>,
							<span class="hljs-string">"trust_votes"</span>:-<span class="hljs-number">1</span>,
							<span class="hljs-string">"children"</span>:[],
							<span class="hljs-string">"parent"</span>:[<span class="hljs-string">"b2"</span>]
				
						
					}
						
					
				];
		
		clln.insert(service_data, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, result</span>)</span>{
			<span class="hljs-keyword">if</span>(err)<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"there was an error in inserting data : "</span>,err);
			<span class="hljs-keyword">else</span> {
				<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"data inserted successfully and is :\n "</span>, result);	
				<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"now finding one doc \n\n"</span>);
				
				getJsonObjectByNameFromDB(<span class="hljs-string">"meta"</span>, clln, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, result</span>)</span>{
					<span class="hljs-keyword">if</span>(err)<span class="hljs-built_in">console</span>.log(err);
					<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (result!=<span class="hljs-literal">null</span>){
						<span class="hljs-keyword">var</span> queue =[];
						<span class="hljs-keyword">var</span> element_list=[];				
						<span class="hljs-keyword">var</span> service_root = result.root;
						<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"the root is "</span>, service_root);
						<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"\n the metadata is \n"</span>);					
						<span class="hljs-built_in">console</span>.log(result);</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>do bfs from (root) and then do a reverse bfs<br>bfs(queue, </p>

            </div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Async task (same in all examples in this chapter)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">async</span>(<span class="hljs-params">ele, callback</span>) </span>{
							<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"it not fucked up even more"</span>);
							element_list.push(ele);</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>read the ele from db</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>							getJsonObjectByNameFromDB(ele, clln, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, result</span>)</span>{
								<span class="hljs-keyword">if</span>(err)callback(err);
								<span class="hljs-keyword">else</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>get its json obj</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>									
									<span class="hljs-keyword">var</span> s_obj= result;
									<span class="hljs-built_in">console</span>.log(s_obj);
									<span class="hljs-keyword">var</span> s_t_votes= <span class="hljs-number">0</span>;
									<span class="hljs-keyword">var</span> s_relevance= s_obj[KEY_CRe];</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>TODO:    it’s better to process these in batches or some units of feedback
otherwise the code will be a blocking code</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>									
									<span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i&lt;s_relevance.length;i++){
										s_t_votes+=s_relevance[i];
									}
									<span class="hljs-keyword">var</span> s_ratings=s_obj[KEY_CRa];
									<span class="hljs-keyword">var</span> s_owr=<span class="hljs-number">0</span>;
									<span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i&lt;s_ratings.length;i++){
										s_owr+=(s_ratings[i]*s_relevance[i]);
									}
									s_owr/=s_t_votes;
									<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"s_t_votes is "</span>, s_t_votes);
									<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"s_ownr is "</span>,s_owr);</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>loop for it’s children and push them into the queue</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>									<span class="hljs-keyword">var</span> s_children = s_obj[KEY_CHILDREN];
									<span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i&lt;s_children.length; i++){
										<span class="hljs-keyword">var</span> s_child = s_children[i];
										queue.push(s_child[KEY_CHILDREN_NAME]);
									}</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>update tx and r(x)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>									clln.update(
										{<span class="hljs-string">"name"</span>:ele}, 
										{
											$set:{
												<span class="hljs-string">"own_wmean_rating"</span>:s_owr,
												<span class="hljs-string">"trust_votes"</span>:s_t_votes
											}
										},
										<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, numUpdated</span>)</span>{
											<span class="hljs-keyword">if</span>(err)<span class="hljs-built_in">console</span>.log(err);
											<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (numUpdated!=<span class="hljs-number">0</span>){
												callback(<span class="hljs-literal">null</span>, numUpdated); 
											}
										}
									);
									
									
								}
							});
						}</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Final task (same in all the examples)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">final</span>(<span class="hljs-params"></span>) </span>{ 
							<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Done updating'</span>); 
							db.close();
						}</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>A simple async series:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">series</span>(<span class="hljs-params">element</span>) </span>{
						  <span class="hljs-keyword">if</span>(element) {
							<span class="hljs-keyword">async</span>( element, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, result</span>) </span>{
							  <span class="hljs-keyword">if</span>(err){
								<span class="hljs-built_in">console</span>.log(err);
							  }
							  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (result!=<span class="hljs-literal">null</span>){
								  <span class="hljs-built_in">console</span>.log( <span class="hljs-string">"Records updated : "</span>, result);
								  <span class="hljs-keyword">return</span> series(queue.shift());
							  }
							});
						  } <span class="hljs-keyword">else</span> {
							<span class="hljs-keyword">return</span> final();
						  }
						}
						
						queue.push(service_root);
						series(queue.shift());
						
					}
				});		
			}
		});	
	}		
});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
