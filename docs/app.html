<!DOCTYPE html>

<html>
<head>
  <title>app.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>app.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">var</span> favicon = <span class="hljs-built_in">require</span>(<span class="hljs-string">'serve-favicon'</span>);
<span class="hljs-keyword">var</span> logger = <span class="hljs-built_in">require</span>(<span class="hljs-string">'morgan'</span>);
<span class="hljs-keyword">var</span> cookieParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cookie-parser'</span>);
<span class="hljs-keyword">var</span> bodyParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">'body-parser'</span>);

<span class="hljs-keyword">var</span> routes = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./routes/index'</span>);
<span class="hljs-keyword">var</span> users = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./routes/users'</span>);

<span class="hljs-keyword">var</span> app = express();</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> mongodb =<span class="hljs-built_in">require</span>(<span class="hljs-string">"mongodb"</span>);
<span class="hljs-keyword">var</span> mongoClient = mongodb.MongoClient;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>connection url - where our mongodb server is running</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> url = <span class="hljs-string">'mongodb://localhost:27017/proto'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>view engine setup</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>app.set(<span class="hljs-string">'views'</span>, path.join(__dirname, <span class="hljs-string">'views'</span>));
app.set(<span class="hljs-string">'view engine'</span>, <span class="hljs-string">'jade'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>uncomment after placing your favicon in /public
app.use(favicon(__dirname + ‘/public/favicon.ico’));</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>app.use(logger(<span class="hljs-string">'dev'</span>));
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: <span class="hljs-literal">false</span> }));
app.use(cookieParser());
app.use(express.static(path.join(__dirname, <span class="hljs-string">'public'</span>)));

app.use(<span class="hljs-string">'/'</span>, routes);
app.use(<span class="hljs-string">'/users'</span>, users);</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>catch 404 and forward to error handler</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>app.use(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{
  <span class="hljs-keyword">var</span> err = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Not Found'</span>);
  err.status = <span class="hljs-number">404</span>;
  next(err);
});</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>error handlers</p>

            </div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>development error handler
will print stacktrace</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">if</span> (app.get(<span class="hljs-string">'env'</span>) === <span class="hljs-string">'development'</span>) {
  app.use(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, req, res, next</span>) </span>{
    res.status(err.status || <span class="hljs-number">500</span>);
    res.render(<span class="hljs-string">'error'</span>, {
      message: err.message,
      error: err
    });
  });
}</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>production error handler
no stacktraces leaked to user</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>app.use(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, req, res, next</span>) </span>{
  res.status(err.status || <span class="hljs-number">500</span>);
  res.render(<span class="hljs-string">'error'</span>, {
    message: err.message,
    error: {}
  });
});


<span class="hljs-built_in">module</span>.exports = app;</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>—————-system parameters——————————————</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> alpha = <span class="hljs-number">0.6</span>;
<span class="hljs-keyword">var</span> beta = <span class="hljs-number">0.5</span>;
<span class="hljs-keyword">var</span> gamma1 = <span class="hljs-number">0.75</span>; <span class="hljs-comment">// for siblings</span>
<span class="hljs-keyword">var</span> gamma2 = <span class="hljs-number">0.25</span>; <span class="hljs-comment">// for cousins</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>——————————— CONSTANTS———————-</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> META= <span class="hljs-string">"meta"</span>;
<span class="hljs-keyword">var</span> KEY_NAME=<span class="hljs-string">"name"</span>;
<span class="hljs-keyword">var</span> KEY_ARS=<span class="hljs-string">"agg_rating_score"</span>;
<span class="hljs-keyword">var</span> KEY_ORC=<span class="hljs-string">"own_rating_cont"</span>;
<span class="hljs-keyword">var</span> KEY_CRC=<span class="hljs-string">"children_rating_cont"</span>;
<span class="hljs-keyword">var</span> KEY_OWR=<span class="hljs-string">"own_wmean_rating"</span>;
<span class="hljs-keyword">var</span> KEY_UWR=<span class="hljs-string">"universe_wmean_rating"</span>;
<span class="hljs-keyword">var</span> KEY_CRa=<span class="hljs-string">"consumer_ratings"</span>;
<span class="hljs-keyword">var</span> KEY_CRe=<span class="hljs-string">"consumer_relevance"</span>;
<span class="hljs-keyword">var</span> KEY_RTV=<span class="hljs-string">"rating_trust_value"</span>;
<span class="hljs-keyword">var</span> KEY_TV=<span class="hljs-string">"trust_votes"</span>;
<span class="hljs-keyword">var</span> KEY_CHILDREN=<span class="hljs-string">"children"</span>;
<span class="hljs-keyword">var</span> KEY_SIBLINGS=<span class="hljs-string">"siblings"</span>;
<span class="hljs-keyword">var</span> KEY_PARENT=<span class="hljs-string">"parent"</span>;
<span class="hljs-keyword">var</span> KEY_CHILDREN_NAME=<span class="hljs-string">"name"</span>;
<span class="hljs-keyword">var</span> KEY_CHILDREN_WT=<span class="hljs-string">"wt"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>————————— global variables</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> element_list=[];				
<span class="hljs-keyword">var</span> service_root;
<span class="hljs-keyword">var</span> queue =[];
<span class="hljs-keyword">var</span> services_children={};
<span class="hljs-keyword">var</span> services_siblings={};
<span class="hljs-keyword">var</span> services_tv={};
<span class="hljs-keyword">var</span> services_owr={};
<span class="hljs-keyword">var</span> services_uwr={};
<span class="hljs-keyword">var</span> services_rtv={};
<span class="hljs-keyword">var</span> services_ars={};</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>——————————- helper methods</p>

            </div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>it assumes that connection has been established</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getJsonObjectByNameFromDB</span>(<span class="hljs-params">collection, name, cb</span>)</span>{
	<span class="hljs-keyword">var</span> myCursor = collection.find({<span class="hljs-string">"name"</span>:name});
	myCursor.limit(<span class="hljs-number">1</span>);			
	myCursor.each(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err,result</span>)</span>{
		<span class="hljs-keyword">if</span>(err)cb(err);
		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(result!=<span class="hljs-literal">null</span>){
			cb(<span class="hljs-string">""</span>, result);
		}
	});
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onConnectionEstablished</span>(<span class="hljs-params">clln, cb</span>)</span>{
	<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'In function onConnectionEstablished: '</span>);
	<span class="hljs-keyword">var</span> service_data = [
				{ 
					name:<span class="hljs-string">"meta"</span>,						
					root:<span class="hljs-string">"a"</span>,
					numServices:<span class="hljs-number">7</span>,
					serviceNames:[<span class="hljs-string">"a"</span>,<span class="hljs-string">"b1"</span>,<span class="hljs-string">"b2"</span>,<span class="hljs-string">"c1"</span>,<span class="hljs-string">"c2"</span>,<span class="hljs-string">"c3"</span>,<span class="hljs-string">"c4"</span>]					
				},
				{
					<span class="hljs-string">"name"</span>:<span class="hljs-string">"a"</span>,
					<span class="hljs-string">"agg_rating_score"</span>:-<span class="hljs-number">1</span>,
					<span class="hljs-string">"own_rating_cont"</span>:-<span class="hljs-number">1</span>,
					<span class="hljs-string">"children_rating_cont"</span>:-<span class="hljs-number">1</span>,
					<span class="hljs-string">"own_wmean_rating"</span>:-<span class="hljs-number">1</span>,						
					<span class="hljs-string">"universe_wmean_rating"</span>:-<span class="hljs-number">1</span>,
					<span class="hljs-string">"consumer_ratings"</span>:[<span class="hljs-number">5</span>,<span class="hljs-number">4</span>],
					<span class="hljs-string">"consumer_relevance"</span>:[<span class="hljs-number">4</span>,<span class="hljs-number">5</span>],
					<span class="hljs-string">"rating_trust_value"</span>:-<span class="hljs-number">1</span>,
					<span class="hljs-string">"trust_votes"</span>:-<span class="hljs-number">1</span>,
					<span class="hljs-string">"children"</span>:[{<span class="hljs-string">"name"</span>:<span class="hljs-string">"b1"</span>,<span class="hljs-string">"wt"</span>:<span class="hljs-number">0.5</span>},{<span class="hljs-string">"name"</span>:<span class="hljs-string">"b2"</span>,<span class="hljs-string">"wt"</span>:<span class="hljs-number">0.5</span>}],
					<span class="hljs-string">"parent"</span>:[],
					<span class="hljs-string">"siblings"</span>:[]
		
				
				},
				{
					<span class="hljs-string">"name"</span>:<span class="hljs-string">"b1"</span>,
					<span class="hljs-string">"agg_rating_score"</span>:-<span class="hljs-number">1</span>,
					<span class="hljs-string">"own_rating_cont"</span>:-<span class="hljs-number">1</span>,
					<span class="hljs-string">"children_rating_cont"</span>:-<span class="hljs-number">1</span>,
					<span class="hljs-string">"own_wmean_rating"</span>:-<span class="hljs-number">1</span>,						
					<span class="hljs-string">"universe_wmean_rating"</span>:-<span class="hljs-number">1</span>,
					<span class="hljs-string">"consumer_ratings"</span>:[<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">3</span>],
					<span class="hljs-string">"consumer_relevance"</span>:[<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">4</span>],
					<span class="hljs-string">"rating_trust_value"</span>:-<span class="hljs-number">1</span>,
					<span class="hljs-string">"trust_votes"</span>:-<span class="hljs-number">1</span>,
					<span class="hljs-string">"children"</span>:[{<span class="hljs-string">"name"</span>:<span class="hljs-string">"c1"</span>,<span class="hljs-string">"wt"</span>:<span class="hljs-number">0.6</span>},{<span class="hljs-string">"name"</span>:<span class="hljs-string">"c2"</span>,<span class="hljs-string">"wt"</span>:<span class="hljs-number">0.4</span>}],
					<span class="hljs-string">"parent"</span>:[<span class="hljs-string">"a"</span>],
					<span class="hljs-string">"siblings"</span>:[<span class="hljs-string">"b2"</span>]
				
				},
				{	
					<span class="hljs-string">"name"</span>:<span class="hljs-string">"b2"</span>,
					<span class="hljs-string">"agg_rating_score"</span>:-<span class="hljs-number">1</span>,
					<span class="hljs-string">"own_rating_cont"</span>:-<span class="hljs-number">1</span>,
					<span class="hljs-string">"children_rating_cont"</span>:-<span class="hljs-number">1</span>,
					<span class="hljs-string">"own_wmean_rating"</span>:-<span class="hljs-number">1</span>,						
					<span class="hljs-string">"universe_wmean_rating"</span>:-<span class="hljs-number">1</span>,
					<span class="hljs-string">"consumer_ratings"</span>:[<span class="hljs-number">5</span>],
					<span class="hljs-string">"consumer_relevance"</span>:[<span class="hljs-number">5</span>],
					<span class="hljs-string">"rating_trust_value"</span>:-<span class="hljs-number">1</span>,
					<span class="hljs-string">"trust_votes"</span>:-<span class="hljs-number">1</span>,
					<span class="hljs-string">"children"</span>:[{<span class="hljs-string">"name"</span>:<span class="hljs-string">"c3"</span>,<span class="hljs-string">"wt"</span>:<span class="hljs-number">0.3</span>},{<span class="hljs-string">"name"</span>:<span class="hljs-string">"c4"</span>,<span class="hljs-string">"wt"</span>:<span class="hljs-number">0.7</span>}],
					<span class="hljs-string">"parent"</span>:[<span class="hljs-string">"a"</span>],
					<span class="hljs-string">"siblings"</span>:[<span class="hljs-string">"b1"</span>]
				
				},	
				{
					<span class="hljs-string">"name"</span>:<span class="hljs-string">"c1"</span>,
					<span class="hljs-string">"agg_rating_score"</span>:-<span class="hljs-number">1</span>,
					<span class="hljs-string">"own_rating_cont"</span>:-<span class="hljs-number">1</span>,
					<span class="hljs-string">"children_rating_cont"</span>:-<span class="hljs-number">1</span>,
					<span class="hljs-string">"own_wmean_rating"</span>:-<span class="hljs-number">1</span>,						
					<span class="hljs-string">"universe_wmean_rating"</span>:-<span class="hljs-number">1</span>,
					<span class="hljs-string">"consumer_ratings"</span>:[<span class="hljs-number">4</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">3</span>],
					<span class="hljs-string">"consumer_relevance"</span>:[<span class="hljs-number">5</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">3</span>],
					<span class="hljs-string">"rating_trust_value"</span>:-<span class="hljs-number">1</span>,
					<span class="hljs-string">"trust_votes"</span>:-<span class="hljs-number">1</span>,
					<span class="hljs-string">"children"</span>:[],
					<span class="hljs-string">"parent"</span>:[<span class="hljs-string">"b1"</span>],
					<span class="hljs-string">"siblings"</span>:[<span class="hljs-string">"c2"</span>]
	
				
				},
				{					
					<span class="hljs-string">"name"</span>:<span class="hljs-string">"c2"</span>,
					<span class="hljs-string">"agg_rating_score"</span>:-<span class="hljs-number">1</span>,
					<span class="hljs-string">"own_rating_cont"</span>:-<span class="hljs-number">1</span>,
					<span class="hljs-string">"children_rating_cont"</span>:-<span class="hljs-number">1</span>,
					<span class="hljs-string">"own_wmean_rating"</span>:-<span class="hljs-number">1</span>,						
					<span class="hljs-string">"universe_wmean_rating"</span>:-<span class="hljs-number">1</span>,
					<span class="hljs-string">"consumer_ratings"</span>:[<span class="hljs-number">3</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>],
					<span class="hljs-string">"consumer_relevance"</span>:[<span class="hljs-number">4</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>],
					<span class="hljs-string">"rating_trust_value"</span>:-<span class="hljs-number">1</span>,
					<span class="hljs-string">"trust_votes"</span>:-<span class="hljs-number">1</span>,
					<span class="hljs-string">"children"</span>:[],
					<span class="hljs-string">"parent"</span>:[<span class="hljs-string">"b1"</span>],
					<span class="hljs-string">"siblings"</span>:[<span class="hljs-string">"c1"</span>]
		
				
				},
				{
					<span class="hljs-string">"name"</span>:<span class="hljs-string">"c3"</span>,
					<span class="hljs-string">"agg_rating_score"</span>:-<span class="hljs-number">1</span>,
					<span class="hljs-string">"own_rating_cont"</span>:-<span class="hljs-number">1</span>,
					<span class="hljs-string">"children_rating_cont"</span>:-<span class="hljs-number">1</span>,
					<span class="hljs-string">"own_wmean_rating"</span>:-<span class="hljs-number">1</span>,						
					<span class="hljs-string">"universe_wmean_rating"</span>:-<span class="hljs-number">1</span>,
					<span class="hljs-string">"consumer_ratings"</span>:[<span class="hljs-number">4</span>,<span class="hljs-number">4</span>],
					<span class="hljs-string">"consumer_relevance"</span>:[<span class="hljs-number">4</span>,<span class="hljs-number">5</span>],
					<span class="hljs-string">"rating_trust_value"</span>:-<span class="hljs-number">1</span>,
					<span class="hljs-string">"trust_votes"</span>:-<span class="hljs-number">1</span>,
					<span class="hljs-string">"children"</span>:[],
					<span class="hljs-string">"parent"</span>:[<span class="hljs-string">"b2"</span>],
					<span class="hljs-string">"siblings"</span>:[<span class="hljs-string">"c4"</span>]
		
				
				},
				{
					<span class="hljs-string">"name"</span>:<span class="hljs-string">"c4"</span>,
					<span class="hljs-string">"agg_rating_score"</span>:-<span class="hljs-number">1</span>,
					<span class="hljs-string">"own_rating_cont"</span>:-<span class="hljs-number">1</span>,
					<span class="hljs-string">"children_rating_cont"</span>:-<span class="hljs-number">1</span>,
					<span class="hljs-string">"own_wmean_rating"</span>:-<span class="hljs-number">1</span>,						
					<span class="hljs-string">"universe_wmean_rating"</span>:-<span class="hljs-number">1</span>,
					<span class="hljs-string">"consumer_ratings"</span>:[<span class="hljs-number">5</span>,<span class="hljs-number">5</span>,<span class="hljs-number">4</span>],
					<span class="hljs-string">"consumer_relevance"</span>:[<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">4</span>],
					<span class="hljs-string">"rating_trust_value"</span>:-<span class="hljs-number">1</span>,
					<span class="hljs-string">"trust_votes"</span>:-<span class="hljs-number">1</span>,
					<span class="hljs-string">"children"</span>:[],
					<span class="hljs-string">"parent"</span>:[<span class="hljs-string">"b2"</span>],
					<span class="hljs-string">"siblings"</span>:[<span class="hljs-string">"c3"</span>]
			
					
				}
					
				
			];
	
	clln.insert(service_data, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, result</span>)</span>{
		<span class="hljs-keyword">if</span>(err)cb(err);
		<span class="hljs-keyword">else</span> {
			cb(<span class="hljs-literal">null</span>, <span class="hljs-string">'Results of insertion are \n'</span>+result);
					
		}
	});
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bfTraversalStep</span>(<span class="hljs-params">clln, ele, callback</span>) </span>{
	element_list.push(ele);</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>read the ele from db</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	getJsonObjectByNameFromDB( clln, ele, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, result</span>)</span>{
		<span class="hljs-keyword">if</span>(err)callback(err);
		<span class="hljs-keyword">else</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>get its json obj</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			
			<span class="hljs-keyword">var</span> s_obj= result;
			<span class="hljs-built_in">console</span>.log(s_obj);
			<span class="hljs-keyword">var</span> s_t_votes= <span class="hljs-number">0</span>;
			<span class="hljs-keyword">var</span> s_relevance= s_obj[KEY_CRe];</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>TODO:    it’s better to process these in batches or some units of feedback
otherwise the code will be a blocking code</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			
			<span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i&lt;s_relevance.length;i++){
				s_t_votes+=s_relevance[i];
			}
			<span class="hljs-keyword">var</span> s_ratings=s_obj[KEY_CRa];
			<span class="hljs-keyword">var</span> s_owr=<span class="hljs-number">0</span>;
			<span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i&lt;s_ratings.length;i++){
				s_owr+=(s_ratings[i]*s_relevance[i]);
			}
			s_owr/=s_t_votes;
			<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"s_t_votes is "</span>, s_t_votes);
			<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"s_owr is "</span>,s_owr);</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>update the local children and the siblings object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			services_children[s_obj[KEY_NAME]]= s_obj[KEY_CHILDREN];
			services_siblings[s_obj[KEY_NAME]]= s_obj[KEY_SIBLINGS];
			services_owr[s_obj[KEY_NAME]]= s_owr;
			services_tv[s_obj[KEY_NAME]]= s_t_votes;</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>loop for it’s children and push them into the queue</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">var</span> s_children = s_obj[KEY_CHILDREN];
			<span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i&lt;s_children.length; i++){
				<span class="hljs-keyword">var</span> s_child = s_children[i];
				queue.push(s_child[KEY_CHILDREN_NAME]);
			}</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>update tx and r(x)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			clln.update(
				{<span class="hljs-string">"name"</span>:ele}, 
				{
					$set:{
						<span class="hljs-string">"own_wmean_rating"</span>:s_owr,
						<span class="hljs-string">"trust_votes"</span>:s_t_votes
					}
				},
				<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, numUpdated</span>)</span>{
					<span class="hljs-keyword">if</span>(err)callback(err);
					<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (numUpdated!=<span class="hljs-number">0</span>){
						callback(<span class="hljs-literal">null</span>, numUpdated); 
					}
				}
			);
			
			
		}
	});
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">uwrCalcStep</span>(<span class="hljs-params">clln, ele, callback</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Update the value of Universe Weighted Mean 
Rating U(x) , for the node/service element ‘ele’
And also calculate the value of the    U(x) for it’s children 
and save it for use by them during the traversal</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	
	<span class="hljs-keyword">var</span> s_uwr=<span class="hljs-number">0</span>;
	<span class="hljs-keyword">var</span> s_name = ele;
	<span class="hljs-keyword">var</span> s_uwr_children=<span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>If the node is root then U(x) = R(x)
i.e, Universe Weighted Mean Rating is equal to
Own Weighted Mean Rating for the node
Otherwise get it from the services_uwr object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	
	<span class="hljs-keyword">if</span>(s_name===service_root){
		s_uwr=services_owr[s_name];
		services_uwr[s_name]=s_uwr;
		
	}
	<span class="hljs-keyword">else</span> {
		s_uwr= services_uwr[s_name];
		<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'\n s_uwr from the services array is \n'</span>);
		<span class="hljs-built_in">console</span>.log(s_uwr);
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Calculation of UWR for the child nodes 
UWR involves the contribution from the siblings 
with weight as gamma1 and from the cousins
with weight gamma2</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	
	<span class="hljs-keyword">var</span> siblings_ra_re=<span class="hljs-number">0</span>;
	<span class="hljs-keyword">var</span> siblings_tv=<span class="hljs-number">0</span>;
	<span class="hljs-keyword">var</span> cousins_ra_re=<span class="hljs-number">0</span>;
	<span class="hljs-keyword">var</span> cousins_tv=<span class="hljs-number">0</span>;
	<span class="hljs-keyword">var</span> s_children=[];
	<span class="hljs-keyword">var</span> s_siblings=services_siblings[s_name];</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>The services_children array has children elements as json objects 
with name and edge weight as the keys </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	
	<span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i&lt;services_children[s_name].length; i++){
		s_children.push(services_children[s_name][i][KEY_CHILDREN_NAME]);
	}
	
	<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"s_siblings "</span>,s_siblings);
	<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"s_children "</span>, s_children, <span class="hljs-string">'\n'</span>);
	
	<span class="hljs-keyword">if</span>(s_children.length!=<span class="hljs-number">0</span>){
		<span class="hljs-keyword">if</span>(s_siblings.length!=<span class="hljs-number">0</span>){
			<span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i&lt;s_siblings.length; i++){</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>for the cousin: s_sibling[i] , find the contribution due to it’s children</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">var</span> cousin_children= [];
				
				<span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> j=<span class="hljs-number">0</span>; j&lt;services_children[s_siblings[i]].length; j++){
					cousin_children.push(services_children[s_siblings[i]][j][KEY_CHILDREN_NAME]);
				}
				
				<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"cousin_children "</span>,cousin_children); 
				<span class="hljs-keyword">if</span>(cousin_children.length!=<span class="hljs-number">0</span>){
					<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j=<span class="hljs-number">0</span>; j&lt;cousin_children.length; j++){
						cousins_ra_re+= (services_owr[cousin_children[j]]*services_tv[cousin_children[j]]);
						cousins_tv+= services_tv[cousin_children[j]];
					}
				}
			}
		}</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>The contribution from the children of the current ‘ele’ (node)
i.e. the siblings </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i&lt;s_children.length; i++){
			<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"services owr "</span>,services_owr[s_children[i]]);
			<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"services tv "</span>,services_tv[s_children[i]]);
			siblings_ra_re+= (services_owr[s_children[i]]*services_tv[s_children[i]]);
			siblings_tv+= services_tv[s_children[i]];
		} 
		<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"siblings_ra_re : "</span>, siblings_ra_re);
		<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"siblings_tv : "</span>, siblings_tv);</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Combining the contribution with appropriate weights</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		s_uwr_children= ( (gamma1*siblings_ra_re) +(gamma2*cousins_ra_re));
		s_uwr_children/= ( (gamma1*siblings_tv) +(gamma2*cousins_tv));
		
		<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"s_uwr_children is : \n"</span>); 
		<span class="hljs-built_in">console</span>.log(s_uwr_children);
		
		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i&lt;s_children.length; i++){
			services_uwr[s_children[i]]=s_uwr_children;
		} 
	}
	<span class="hljs-keyword">else</span> {
		<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"it has no children"</span>);
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Update UWR of the current service element(node) in the database</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	clln.update(
		{<span class="hljs-string">"name"</span>:ele}, 
		{
			$set:{
				<span class="hljs-string">"universe_wmean_rating"</span>:s_uwr,
			}
		},
		<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, numUpdated</span>)</span>{
			<span class="hljs-keyword">if</span>(err)callback(err);
			<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (numUpdated!=<span class="hljs-number">0</span>){
				<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"updating uwr values "</span>);
				callback(<span class="hljs-literal">null</span>, numUpdated); 
			}
		}
	);
	
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">remainingScoresCalcStep</span>(<span class="hljs-params">clln, ele, callback</span>) </span>{
	
	
	<span class="hljs-keyword">var</span> s_name = ele;
	<span class="hljs-keyword">var</span> s_uwr=services_uwr[s_name];
	<span class="hljs-keyword">var</span> s_owr=services_owr[s_name];
	<span class="hljs-keyword">var</span> s_tv=services_tv[s_name];
	
	<span class="hljs-keyword">var</span> s_ars=<span class="hljs-number">0</span>;
	<span class="hljs-keyword">var</span> s_orc=<span class="hljs-number">0</span>;
	<span class="hljs-keyword">var</span> s_crc=<span class="hljs-number">0</span>;
	<span class="hljs-keyword">var</span> s_rtv=<span class="hljs-number">0</span>;
	<span class="hljs-keyword">var</span> s_crc_num=<span class="hljs-number">0</span>;
	<span class="hljs-keyword">var</span> s_crc_denom=<span class="hljs-number">0</span>;
	
	<span class="hljs-keyword">var</span> s_children=services_children[s_name];
	<span class="hljs-keyword">var</span> s_children_name=[];
	<span class="hljs-keyword">var</span> s_children_wt=[];
	<span class="hljs-keyword">var</span> s_num_children = s_children.length;
	
	<span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i&lt;s_num_children; i++){
		s_children_name.push(s_children[i][KEY_CHILDREN_NAME]);
		s_children_wt.push(s_children[i][KEY_CHILDREN_WT]);
	}
	
	s_orc= ((beta*s_owr)+((<span class="hljs-number">1</span>-beta)*s_uwr));
	s_rtv= s_tv;
	<span class="hljs-keyword">if</span>(s_num_children!=<span class="hljs-number">0</span>){
		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i&lt;s_num_children; i++){
			<span class="hljs-keyword">var</span> s_child_name=s_children_name[i];
			s_rtv+= (services_rtv[s_child_name]/<span class="hljs-number">2</span>);
			s_crc_num+= (services_ars[s_child_name]*services_rtv[s_child_name]*s_children_wt[i]);
			s_crc_denom+= (services_rtv[s_child_name]*s_children_wt[i]);
		} 
		s_crc= s_crc_num/s_crc_denom;
		s_ars= (alpha*s_orc) + ((<span class="hljs-number">1</span>-alpha)*s_crc);
	
	}
	<span class="hljs-keyword">else</span> {
		s_ars=s_orc;
	}
	
	services_ars[s_name]=s_ars;
	services_rtv[s_name]=s_rtv;	
	
	clln.update(
		{<span class="hljs-string">"name"</span>:ele}, 
		{
			$set:{
				<span class="hljs-string">"agg_rating_score"</span>:s_ars,
				<span class="hljs-string">"own_rating_cont"</span>:s_orc,
				<span class="hljs-string">"children_rating_cont"</span>:s_crc,
				<span class="hljs-string">"rating_trust_value"</span>:s_rtv,
			}
		},
		<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, numUpdated</span>)</span>{
			<span class="hljs-keyword">if</span>(err)callback(err);
			<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (numUpdated!=<span class="hljs-number">0</span>){
				<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"updating uwr values "</span>);
				callback(<span class="hljs-literal">null</span>, numUpdated); 
			}
		}
	);
	
}</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Final task for traversal</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onBFTraversalComplete</span>(<span class="hljs-params">cb</span>) </span>{ 
	cb(<span class="hljs-literal">null</span>,<span class="hljs-string">'Done updating'</span>); 
}</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>A general async bfTraversal:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bfTraversal</span>(<span class="hljs-params">clln, element, traversalStep, cb</span>) </span>{
  <span class="hljs-keyword">if</span>(element) {
	traversalStep( clln, element, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, result</span>) </span>{
	  <span class="hljs-keyword">if</span>(err){
		cb(err);
	  }
	  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (result!=<span class="hljs-literal">null</span>){
		  <span class="hljs-built_in">console</span>.log( <span class="hljs-string">"Records updated : "</span>, result);
		  <span class="hljs-keyword">return</span> bfTraversal(clln, queue.shift(),traversalStep, cb);
	  }
	});
  } <span class="hljs-keyword">else</span> {
	<span class="hljs-keyword">return</span> onBFTraversalComplete(cb);
  }
}
			
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateTvAndOwr</span>(<span class="hljs-params">clln, cb</span>)</span>{
	
	<span class="hljs-built_in">console</span>.log(<span class="hljs-string">" In function updateTvAndOwr : now finding one doc \n\n"</span>);
			
	getJsonObjectByNameFromDB(clln, <span class="hljs-string">"meta"</span>,  <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, result</span>)</span>{
		<span class="hljs-keyword">if</span>(err)cb(err);
		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (result!=<span class="hljs-literal">null</span>){
			service_root = result.root;
			<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"the root is "</span>, service_root);
			<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"\n the metadata is \n"</span>);					
			<span class="hljs-built_in">console</span>.log(result);</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>do bfs from (root) and then do a reverse bfs<br>bfs(queue, </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
			queue.push(service_root);
			bfTraversal(clln, queue.shift(), bfTraversalStep, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, result</span>)</span>{
				<span class="hljs-keyword">if</span>(err)cb(err);
				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(result!=<span class="hljs-literal">null</span>){
					cb(<span class="hljs-literal">null</span>,result);
				}
			});</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Async task corresponding to a breadth first traversal
Read a service , update it’s trust votes and own weighted rating
and at last append it’s children services to the queue</p>

            </div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>TODO: Also check out that keys are not working when used in form of constants</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			
		}
	});
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateUWR</span>(<span class="hljs-params">clln, cb</span>)</span>{
	<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'In function updateOtherScores: '</span>);
	<span class="hljs-built_in">console</span>.log(element_list);
	<span class="hljs-built_in">console</span>.log(services_children);
	<span class="hljs-built_in">console</span>.log(services_siblings);
	<span class="hljs-built_in">console</span>.log(services_owr);
	<span class="hljs-built_in">console</span>.log(services_tv);
	queue=[];
	<span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i&lt;element_list.length; i++){
		queue.push(element_list[i]);
	}
	<span class="hljs-built_in">console</span>.log(queue);
	bfTraversal(clln, queue.shift(), uwrCalcStep, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err,result</span>)</span>{
		<span class="hljs-keyword">if</span>(err)cb(err);
		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(result!=<span class="hljs-literal">null</span>){</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>cb(result);
update other scores - initialise queue and define another traversal step for that</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			cb(<span class="hljs-literal">null</span>, <span class="hljs-string">'UWR scores are updated'</span>);
		}
	});	
	
	
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateRemainingScores</span>(<span class="hljs-params">clln, cb</span>)</span>{
	<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'In function updateRemainingScores: '</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Now traversal will be done from bottom to up</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	
	queue=[];
	<span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=element_list.length-<span class="hljs-number">1</span>; i&gt;=<span class="hljs-number">0</span>; i--){
		queue.push(element_list[i]);
	}
	<span class="hljs-built_in">console</span>.log(queue);
	
	bfTraversal(clln, queue.shift(), remainingScoresCalcStep, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err,result</span>)</span>{
		<span class="hljs-keyword">if</span>(err)cb(err);
		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(result!=<span class="hljs-literal">null</span>){
			<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Updated remaning ratings for the tree"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>cb(result);
update other scores - initialise queue and define another traversal step for that</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			cb(<span class="hljs-literal">null</span>, <span class="hljs-string">'other scores are updated'</span>);
		}
	});	
	
	
}</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>TODO: aggregate feedback from the last saved point </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">aggregateFeedbackFromStart</span>(<span class="hljs-params">clln, cb</span>)</span>{
	<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'In function aggregateFeedbackFromStart: '</span>);
	updateTvAndOwr(clln, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, result</span>)</span>{
		<span class="hljs-keyword">if</span>(err)cb(err);
		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (result!=<span class="hljs-literal">null</span>){
			
			<span class="hljs-built_in">console</span>.log(result);</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>update u_x and other scores for all other services</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			updateUWR(clln, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, result</span>)</span>{
				<span class="hljs-keyword">if</span>(err)cb(err);
				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (result!=<span class="hljs-literal">null</span>){
					<span class="hljs-built_in">console</span>.log(result);
					
					updateRemainingScores(clln, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, result</span>)</span>{
						<span class="hljs-keyword">if</span> (err)cb(err);
						<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (result!=<span class="hljs-literal">null</span>){
							<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Remaining scores also updated"</span>);
							cb(<span class="hljs-literal">null</span>, result);
						}
					});
				}
			});
				
		}
	});
}</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>mongoClient.connect(url, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, db</span>)</span>{
	<span class="hljs-keyword">if</span>(err) <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"there was an error: "</span> ,err);
	<span class="hljs-keyword">else</span> {
				
		<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"connection esatblished to url "</span>,url);
		<span class="hljs-keyword">var</span> clln = db.collection(<span class="hljs-string">"services"</span>);
		
		onConnectionEstablished(clln, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, result</span>)</span>{
			<span class="hljs-keyword">if</span>(err)<span class="hljs-built_in">console</span>.log(err);
			<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (result!=<span class="hljs-literal">null</span>){
				
				<span class="hljs-built_in">console</span>.log(result); <span class="hljs-comment">// intermediate result</span>
				aggregateFeedbackFromStart(clln, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, result</span>)</span>{
					<span class="hljs-keyword">if</span>(err)<span class="hljs-built_in">console</span>.log(err);
					<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (result!=<span class="hljs-literal">null</span>){
						
						<span class="hljs-built_in">console</span>.log(result);
						
						db.close();
					}
				});
				
					
			}
		});
		
	}		
});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
